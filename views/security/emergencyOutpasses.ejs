<% 
  // safe fallbacks
  const outpassesSafe = Array.isArray(outpasses) ? outpasses : [];
  const roomQuerySafe = typeof roomQuery !== 'undefined' ? roomQuery : '';
  const userSafe = session && session.user ? session.user : (user || { name: 'Security' });
  const countSafe = (typeof countToday !== 'undefined' && countToday !== null) ? countToday : outpassesSafe.length;
%>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Outpasses — Security</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    :root { --bg:#091726; --panel: rgba(255,255,255,0.03); --accent:#ffcc00; --muted:#cfe0f5; }
    body{ margin:0; font-family: "Segoe UI", Roboto, Arial; min-height:100vh; background: linear-gradient(180deg,#071025 0%, #0d233f 100%); color:#fff; }
    .wrap{ max-width:1100px; margin:28px auto; padding:18px; }
    .header{ display:flex; align-items:center; gap:16px; justify-content:center; text-align:center; }
    .header img{ height:72px; border-radius:8px; filter: drop-shadow(0 6px 18px rgba(0,0,0,0.6)); }
    h1{ margin:8px 0 2px; color:var(--accent); font-size:20px; }
    p.sub{ margin:0; color:var(--muted); font-weight:600; }

    .card{ background:var(--panel); border-radius:12px; padding:18px; margin-top:18px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }

    .controls{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .controls form{ display:flex; gap:8px; align-items:center; }
    input[type="text"]{ padding:10px 12px; border-radius:8px; border:none; min-width:180px; background:rgba(255,255,255,0.04); color:#fff; }
    button{ background:var(--accent); border:none; color:#07203b; padding:10px 14px; border-radius:8px; font-weight:800; cursor:pointer; }

    .stat { margin-top:14px; font-weight:700; color:var(--muted); }
    .stat strong{ color:var(--accent); font-size:1.05rem; margin-left:6px; }

    table{ width:100%; border-collapse:collapse; margin-top:14px; font-size:0.95rem; color:#eef6ff; }
    thead th{ text-align:left; color:var(--accent); padding:12px 14px; font-weight:800; background:rgba(0,0,0,0.2); }
    tbody td{ padding:12px 14px; border-top:1px solid rgba(255,255,255,0.03); color:#dcefff; vertical-align:middle; }
    tbody tr:hover{ background: rgba(255,255,255,0.02); transform: translateY(-1px); }

    .status { padding:6px 10px; border-radius:999px; font-weight:700; font-size:0.85rem; display:inline-block; }
    .status.Approved{ background:#e6f7ea; color:#0b6f2b; }
    .status.Pending{ background:#fff7e6; color:#6b4a00; }
    .status.Rejected{ background:#ffe6e6; color:#8b1b1b; }

    @media (max-width:800px){
      .controls{ flex-direction:column; align-items:stretch; gap:8px; }
      input[type="text"]{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <img src="/images/college_logo.png" alt="logo">
      <div>
        <h1>Security — Emergency Outpasses</h1>
        <p class="sub">Welcome, <%= userSafe.name || userSafe %> — Today: <strong><%= countSafe %></strong> approved</p>
      </div>
    </header>

    <div class="card">
      <div class="controls" role="region" aria-label="search and actions">
        <form action="/security/dashboard" method="GET" aria-label="search by room">
          <input type="text" name="room_no" placeholder="Search by Room No (e.g. A101)" value="<%= roomQuerySafe %>">
          <button type="submit"><i class="fa fa-search"></i> Search</button>
        </form>

        <div class="stat">Showing <strong><%= outpassesSafe.length %></strong> approved outpass(es) for today</div>
      </div>

      <table role="table" aria-label="today's approved emergency outpasses">
        <thead>
          <tr>
            <th>Student</th>
            <th>Room</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Approved By</th>
            <th>Approved At</th>
          </tr>
        </thead>
        <tbody>
        <% if (outpassesSafe.length === 0) { %>
          <tr><td colspan="6" style="text-align:center; padding:18px; color:#bcd6ff;">No approved outpasses for today.</td></tr>
        <% } else { %>
          <% outpassesSafe.forEach(op => { 
               const studentName = op.name || op.student_name || op.student || '-';
               const room = op.room_no || op.room || '-';
               const reason = op.reason || op.purpose || '-';
               const status = op.status || '-';
               const approvedAt = op.approved_at || op.updated_at || op.created_at || null;
          %>
            <tr>
              <td><%= studentName %></td>
              <td><%= room %></td>
              <td><%= reason %></td>
              <td><span class="status <%= status %>"><%= status %></span></td>
              <td><%= op.accepted_by || op.approved_by || '-' %></td>
              <td><%= approvedAt ? new Date(approvedAt).toLocaleString() : '-' %></td>
            </tr>
          <% }) %>
        <% } %>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
