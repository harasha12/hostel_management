

<style>
/* ============================
   FORCE-HIDE ANY SIDEBAR (PAGE)
   ============================
   Covers many common sidebar selectors used in templates.
   These rules are page-local and use !important to override theme CSS.
*/
#sidebar, .sidebar, aside, .left-nav, .sidenav, nav.sidebar, .app-sidebar,
.sidepanel, .side-nav, .nav-left, .sidebar-wrapper, .layout-sidebar, .app-menu {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important;
  min-width: 0 !important;
  max-width: 0 !important;
  overflow: hidden !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* Expand main content area to full width */
#main, .main-content, .content, .container, .app-body, .layout, .page-container, .app-wrap {
  margin-left: 0 !important;
  padding-left: 16px !important;
  padding-right: 16px !important;
  width: 100% !important;
  max-width: 1400px !important;
}

/* Remove global left page padding */
body, .app, .app-wrap {
  padding-left: 0 !important;
  overflow-x: hidden;
}

/* ============================
   THEME & LAYOUT
   ============================ */
:root{
  --bg: #f4fbf7;
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #156244;
  --accent-2: #1f7a52;
  --danger: #d9534f;
  --warning: #ffb700;
  --shadow-lg: 0 18px 40px rgba(9,30,20,0.08);
  --shadow-md: 0 8px 20px rgba(9,30,20,0.06);
  --radius-lg: 14px;
  --radius-md: 10px;
  --max-width: 1180px;
  --mobile-break: 820px;
  --font-sans: Inter, Poppins, "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: var(--font-sans);
  background: linear-gradient(180deg, var(--bg), #eefaf2);
  color: #07201a;
  -webkit-font-smoothing:antialiased;
  padding: 28px;
  display:flex;
  justify-content:center;
}

/* Main page card */
.page-wrapper{
  width:100%;
  max-width: var(--max-width);
  background: linear-gradient(180deg, rgba(255,255,255,0.98), var(--card));
  border-radius: var(--radius-lg);
  padding:22px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(10,20,16,0.03);
}

/* Header */
.header-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
.title h1{ margin:0; font-size:20px; color:var(--accent-2); display:flex; align-items:center; gap:8px; }
.subtitle{ margin-top:6px; color:var(--muted); font-size:13px; }

/* Actions */
.actions{ display:flex; gap:10px; align-items:center; }
.btn{ padding:9px 14px; border-radius:10px; border:1px solid rgba(10,20,16,0.06); background:transparent; font-weight:700; color:#083626; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
.btn.primary{ background: linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; border:none; box-shadow:var(--shadow-md); }

/* Filter form */
#filterForm{ display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:12px; align-items:end; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(15,138,87,0.03), rgba(15,138,87,0.01)); border:1px solid rgba(15,138,87,0.06); margin-bottom:16px; }
.form-field{ display:flex; flex-direction:column; }
label.small{ font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:600; }
select, input[type="text"], input[type="number"]{ padding:10px 12px; border-radius:8px; border:1px solid rgba(10,20,16,0.06); font-size:14px; background:#fff; color:#062017; outline:none; }
select:focus, input:focus{ box-shadow:0 6px 18px rgba(15,138,87,0.06); border-color:var(--accent); }

/* Table */
.table-wrap{ width:100%; overflow-x:auto; border-radius:10px; margin-bottom:14px; }
.table{ width:100%; border-collapse:collapse; min-width:720px; }
.table thead th{ position:sticky; top:0; background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; padding:12px 10px; font-size:12px; text-transform:uppercase; text-align:center; }
.table tbody td{ padding:12px 10px; border-bottom:1px solid rgba(10,20,16,0.04); font-size:14px; color:#073126; vertical-align:middle; }
.table tbody tr:hover td{ background: linear-gradient(90deg, #f7fff9, #fbfff9); }

/* Utilities */
.col-id{ width:12%; text-align:center; font-weight:700; color:var(--accent-2); }
.col-name{ width:30%; }
.col-center{ text-align:center; }
.badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; }
.badge.warn{ background: rgba(245,158,11,0.08); color:var(--warning); border:1px solid rgba(245,158,11,0.12); }
.badge.success{ background: rgba(16,185,129,0.08); color:#0b5134; border:1px solid rgba(16,185,129,0.12); }
.badge.danger{ background: rgba(217,83,79,0.08); color:var(--danger); border:1px solid rgba(217,83,79,0.12); }

/* Attendance select */
select.attendance-select{ padding:8px 10px; border-radius:8px; min-width:120px; font-weight:600; color:var(--accent-2); }

/* Mobile cards */
.cards{ display:none; gap:12px; }
.card{ background: linear-gradient(180deg,#fff,#fbfff9); padding:12px; border-radius:12px; border:1px solid rgba(10,20,16,0.03); box-shadow:var(--shadow-md); }
.card .meta{ color:var(--muted); font-size:13px; }

/* Footer actions */
.footer-actions{ display:flex; justify-content:flex-end; gap:12px; margin-top:14px; }

/* Responsive */
@media (max-width: 1024px) { #filterForm { grid-template-columns: 1fr 1fr; } }
@media (max-width: var(--mobile-break)) {
  #filterForm { grid-template-columns: 1fr; }
  .header-row { flex-direction: column; align-items:flex-start; gap:8px; }
  .table-wrap{ display:none; }   /* hide table on mobile */
  .cards{ display:block; }       /* show cards on mobile */
  .footer-actions{ justify-content:space-between; }
  .title h1{ font-size:18px; }
}
@media (max-width:420px){ .page-wrapper{ padding:16px; } .btn.primary{ width:100%; } }

.text-muted{ color:var(--muted); font-weight:600; font-size:13px; }
.view-link{ color:var(--accent); text-decoration:none; font-weight:700; }
.view-link:hover{ text-decoration:underline; color:var(--accent-2); }
</style>

<div class="page-wrapper" role="main" aria-labelledby="pageTitle">
  <div class="header-row">
    <div class="title">
      <h1 id="pageTitle">üìã Mark Attendance</h1>
      <div class="subtitle">
        <%= block ? `Block: ${block}` : '' %> <%= year ? ` | Year: ${year}` : '' %> <%= room_no ? ` | Room: ${room_no}` : '' %>
      </div>
    </div>

    <div class="actions" role="toolbar" aria-label="Page actions">
      <a href="/warden/dashboard" class="btn">üè† Dashboard</a>
      <a href="/warden/markAttendance" class="btn">üîÑ Reset</a>
    </div>
  </div>

  <!-- filter form -->
  <form id="filterForm" action="/warden/markAttendance" method="GET" autocomplete="off" novalidate>
    <div class="form-field">
      <label class="small" for="blockSelect">Block</label>
      <select id="blockSelect" name="block" required>
        <option value="">Select Block</option>
        <option value="Old Block" <%= block === "Old Block" ? "selected" : "" %>>Old Block</option>
        <option value="New Block" <%= block === "New Block" ? "selected" : "" %>>New Block</option>
        <option value="GYM Block" <%= block === "GYM Block" ? "selected" : "" %>>GYM Block</option>
        <option value="Main Block" <%= block === "Main Block" ? "selected" : "" %>>Amenities</option>
      </select>
    </div>

    <div class="form-field">
      <label class="small" for="yearSelect">Year</label>
      <select id="yearSelect" name="year" required>
        <option value="">Select Year</option>
        <option value="1" <%= year == 1 ? "selected" : "" %>>1st Year</option>
        <option value="2" <%= year == 2 ? "selected" : "" %>>2nd Year</option>
        <option value="3" <%= year == 3 ? "selected" : "" %>>3rd Year</option>
        <option value="4" <%= year == 4 ? "selected" : "" %>>4th Year</option>
      </select>
    </div>

    <div class="form-field">
      <label class="small" for="roomSelect">Room</label>
      <select id="roomSelect" name="room_no" required>
        <option value="">Select Room</option>
        <% if (rooms && rooms.length > 0) { %>
          <% rooms.forEach(r => { %>
            <option value="<%= r %>" <%= r === room_no ? "selected" : "" %>><%= r %></option>
          <% }) %>
        <% } %>
      </select>
    </div>

    <div style="display:flex; align-items:center; justify-content:flex-end;">
      <button type="submit" class="btn primary">Show Students</button>
    </div>
  </form>

  <% if (students && students.length > 0) { %>
    <form action="/warden/submitAttendance" method="POST" novalidate>
      <input type="hidden" name="block" value="<%= block %>">
      <input type="hidden" name="year" value="<%= year %>">
      <input type="hidden" name="room_no" value="<%= room_no %>">

      <div class="table-wrap" role="region" aria-label="Students table">
        <table class="table" role="table" aria-describedby="pageTitle">
          <thead>
            <tr>
              <th scope="col">Student ID</th>
              <th scope="col">Name</th>
              <th scope="col">Room</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            <% students.forEach(stu => { %>
              <tr>
                <td class="col-id"><%= stu.student_id %></td>
                <td class="col-name"><%= stu.name %></td>
                <td class="col-center"><%= stu.room_no %></td>

                <% if (stu.leave_status === "On Leave") { %>
                  <td class="col-center">
                    <span class="badge warn">ON LEAVE</span>
                    <input type="hidden" name="attendance_<%= stu.student_id %>" value="On Leave">
                  </td>
                <% } else { %>
                  <td class="col-center">
                    <select name="attendance_<%= stu.student_id %>" class="attendance-select" aria-label="Attendance for <%= stu.name %>">
                      <option value="Present" selected>Present</option>
                      <option value="Absent">Absent</option>
                    </select>
                  </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:14px;">
        <div class="text-muted">Total students: <strong><%= students.length %></strong></div>
        <div>
          <button type="submit" class="btn primary">‚úÖ Submit Attendance</button>
        </div>
      </div>
    </form>

    <!-- mobile cards -->
    <div class="cards" aria-hidden="false" style="margin-top:16px;">
      <% students.forEach(stu => { %>
        <div class="card" role="group" aria-label="Student <%= stu.student_id %>">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:800; color:var(--accent-2);"><%= stu.name %></div>
              <div class="meta" style="margin-top:6px;">ID: <strong><%= stu.student_id %></strong> ‚Ä¢ Room: <strong><%= stu.room_no %></strong> ‚Ä¢ Year: <strong><%= stu.year %></strong></div>
            </div>

            <div>
              <% if (stu.leave_status === "On Leave") { %>
                <span class="badge warn">ON LEAVE</span>
              <% } else { %>
                <form style="display:inline;" action="/warden/submitAttendance" method="POST">
                  <input type="hidden" name="block" value="<%= block %>">
                  <input type="hidden" name="year" value="<%= year %>">
                  <input type="hidden" name="room_no" value="<%= room_no %>">
                  <input type="hidden" name="attendance_<%= stu.student_id %>" id="attendance_<%= stu.student_id %>" value="Present">
                  <select class="attendance-select" onchange="document.getElementById('attendance_<%= stu.student_id %>').value=this.value;">
                    <option value="Present">Present</option>
                    <option value="Absent">Absent</option>
                  </select>
                </form>
              <% } %>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <a href="/warden/student/<%= stu.student_id %>" class="view-link">üëÅ View profile</a>
            <% const totalFee = parseFloat(stu.total_fee || 0); const paid = parseFloat(stu.total_paid || 0); const due = totalFee - paid; %>
            <% const att = stu.attendanceSummary && stu.attendanceSummary.total_classes > 0 ? ((stu.attendanceSummary.present_count / stu.attendanceSummary.total_classes) * 100).toFixed(1) : '0.0'; const attNum = parseFloat(att) || 0; %>
            <div style="display:flex; gap:12px; align-items:center;">
              <div class="text-muted">Due: <strong>‚Çπ <%= due.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) %></strong></div>
              <div><span class="badge <%= attNum < 75 ? 'danger' : 'success' %>"><%= att %>%</span></div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <hr style="margin-top:18px; border:0; height:1px; background:linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02));">

    <!-- Overview -->
    <section style="margin-top:12px;">
      <h3 style="margin:0 0 12px 0; color:var(--accent-2);">üìä Students Overview</h3>

      <div class="table-wrap">
        <table class="table" role="table">
          <thead>
            <tr>
              <th style="text-align:left;">Name</th>
              <th style="text-align:left;">Reg ID</th>
              <th style="text-align:left;">Course</th>
              <th class="col-center">Year</th>
              <th class="col-center">Paid (‚Çπ)</th>
              <th class="col-center">Due (‚Çπ)</th>
              <th class="col-center">Fee Status</th>
              <th class="col-center">Attendance %</th>
              <th class="col-center">Profile</th>
            </tr>
          </thead>
          <tbody>
            <% students.forEach(stu => {
                 const totalFee = parseFloat(stu.total_fee || 0);
                 const paid = parseFloat(stu.total_paid || 0);
                 const due = totalFee - paid;
                 const feeStatus = due <= 0 ? { text: "Fully Paid", class: "success" } : { text: "Due", class: "warn" };
                 const att = stu.attendanceSummary && stu.attendanceSummary.total_classes > 0 ? ((stu.attendanceSummary.present_count / stu.attendanceSummary.total_classes) * 100).toFixed(1) : '0.0';
                 const attNum = parseFloat(att) || 0;
            %>
              <tr>
                <td><%= stu.name %></td>
                <td class="text-muted"><%= stu.student_unique_id %></td>
                <td><%= stu.course %></td>
                <td class="col-center"><%= stu.year %></td>
                <td class="col-center">‚Çπ <%= paid.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) %></td>
                <td class="col-center">‚Çπ <%= due.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) %></td>
                <td class="col-center"><span class="badge <%= feeStatus.class %>"><%= feeStatus.text %></span></td>
                <td class="col-center"><span class="badge <%= attNum < 75 ? 'danger' : 'success' %>"><%= att %>%</span></td>
                <td class="col-center"><a href="/warden/student/<%= stu.student_id %>" class="view-link">üëÅ View</a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- mobile overview cards -->
      <div class="cards" style="margin-top:12px;">
        <% students.forEach(stu => {
             const totalFee = parseFloat(stu.total_fee || 0);
             const paid = parseFloat(stu.total_paid || 0);
             const due = totalFee - paid;
             const att = stu.attendanceSummary && stu.attendanceSummary.total_classes > 0 ? ((stu.attendanceSummary.present_count / stu.attendanceSummary.total_classes) * 100).toFixed(1) : '0.0';
             const attNum = parseFloat(att) || 0;
        %>
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:800;"><%= stu.name %></div>
                <div class="text-muted">Reg: <%= stu.student_unique_id %></div>
              </div>
              <div style="text-align:right">
                <div class="text-muted" style="font-size:13px;">Paid: ‚Çπ <%= paid.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) %></div>
                <div style="margin-top:8px;"><span class="badge <%= attNum < 75 ? 'danger' : 'success' %>"><%= att %>%</span></div>
              </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
              <a href="/warden/student/<%= stu.student_id %>" class="view-link">üëÅ View profile</a>
              <div class="text-muted">Due: ‚Çπ <%= due.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) %></div>
            </div>
          </div>
        <% }) %>
      </div>
    </section>

    <div class="footer-actions">
      <a href="/warden/markAttendance" class="btn">‚¨Ö Back</a>
      <a href="/warden/dashboard" class="btn">üè† Dashboard</a>
    </div>

  <% } else { %>
    <div style="padding:28px; text-align:center; color:var(--muted); font-size:15px;">
      No students found for the selected filter.
    </div>
  <% } %>
</div>

<script>
  (function(){
    const blockSelect = document.getElementById('blockSelect');
    const yearSelect  = document.getElementById('yearSelect');
    const roomSelect  = document.getElementById('roomSelect');
    const roomsByBlock = JSON.parse('<%- JSON.stringify(roomsByBlock || {}) %>');
    const initialRoomNo = '<%= room_no || "" %>';

    function updateRooms(){
      if (!roomSelect) return;
      roomSelect.innerHTML = '<option value="">Select Room</option>';
      const b = blockSelect ? blockSelect.value : '';
      if (b && roomsByBlock[b]) {
        roomsByBlock[b].forEach(r=>{
          const o = document.createElement('option');
          o.value = r; o.text = r;
          if (r === initialRoomNo) o.selected = true;
          roomSelect.appendChild(o);
        });
      }
    }
    if (blockSelect) blockSelect.addEventListener('change', updateRooms);
    if (yearSelect) yearSelect.addEventListener('change', updateRooms);
    updateRooms();

    // prevent accidental double submits
    document.querySelectorAll('form').forEach(f=>{
      f.addEventListener('submit', e=>{
        const btn = f.querySelector('button[type="submit"]');
        if (btn){ btn.disabled = true; setTimeout(()=>btn.disabled=false, 1500); }
      });
    });
  })();
</script>


